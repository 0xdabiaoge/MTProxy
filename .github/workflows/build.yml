name: Build MTProxy Python Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: linux-amd64-glibc
            os: ubuntu-latest
            target: glibc
          - name: linux-amd64-musl
            os: ubuntu-latest
            target: musl

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Glibc Version (Debian/Ubuntu)
        if: matrix.target == 'glibc'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-dev
          pip3 install pyinstaller cryptography uvloop
          
          git clone -b master https://github.com/alexbers/mtprotoproxy.git
          cd mtprotoproxy
          if [ -f requirements.txt ]; then pip3 install -r requirements.txt; fi
          pip3 install cryptography uvloop
          
          pyinstaller --onefile --name mtp-python-glibc mtprotoproxy.py
          mv dist/mtp-python-glibc ../

      - name: Build Musl Version (Alpine)
        if: matrix.target == 'musl'
        run: |
          # Use Docker to build in an Alpine environment
          docker run --rm -v $(pwd):/work -w /work python:3.11-alpine sh -c "
            apk add --no-cache gcc musl-dev libffi-dev openssl-dev make git
            pip install pyinstaller cryptography uvloop
            git clone -b master https://github.com/alexbers/mtprotoproxy.git
            cd mtprotoproxy
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            pip install cryptography uvloop
            pyinstaller --onefile --name mtp-python-musl mtprotoproxy.py
            mv dist/mtp-python-musl /work/
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mtproxy-python-${{ matrix.target }}
          path: mtp-python-*
